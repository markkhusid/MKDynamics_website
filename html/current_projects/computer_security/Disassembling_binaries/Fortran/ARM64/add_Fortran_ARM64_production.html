<!DOCTYPE html>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58919029-1', 'auto');
  ga('send', 'pageview');

</script>

<html>

<head>
  <meta content="text/html; charset=utf-8" http-equiv="content-type">
  <meta name="robots" content="follow" />
  
  <title>
    MK Dynamics - Computer Security - Disassembling Binaries - Fortran - ARM 64-Bit Platform
  </title>
  
  <link href="../../../../../css/styles.css" type = "text/css" rel = "stylesheet" />
  
  <style>
    .content {
	overflow: auto;
	height: 80%; 
	background: url("../../../../../images/saturn.jpg") no-repeat center center fixed;
	background-size: cover;
	background-position: center;
	padding: 10px;
	margin: 10px;
	border: 5px solid black;
      }
      
    h1, h2, h3, h4 {
      color: white;
      display: block;     
    }
    
    .current_project_1 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 200px;
      top		: 0px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding-left	: 10px;
    }
    
    .current_project_2 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 2600px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding-left	: 10px;
    }
    
    .current_project_3 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 2600px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding-left	: 10px;
    }
    
    .current_project_4 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 4500px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding		: 10px;
    }
    
    .current_project_5 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 1500px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding		: 10px;
    }
    
    .current_project_6 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 1500px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding		: 10px;
    }
    
    .current_project_7 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 1500px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding		: 10px;
    }
    
    .current_project_8 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 1500px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding		: 10px;
    }
    
    .current_project_9 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 1500px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding		: 10px;
    }
    
    .current_project_10 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 1500px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding		: 10px;
    }
    
    .current_project_11 {
      border		: 5px solid black;
      background	: gray;
      position		: relative;
      width		: 1360px;
      height		: 1500px;
      top		: 000px;
      left		: 0px;
      float		: left;
      margin		: 10px;
      padding		: 10px;
    }
    
    div .img {
      margin		: 0px;
      padding		: 10px;
      height		: auto;
      width		: auto;
      float		: left;
    }
    
    div .img img {
      display		: inline;
      margin		: 0px;
      padding		: 0px;
    }
    
    div .desc {
      color		: white;
      width		: 600px;
      margin		: 5px;
      padding		: 10px;
    }
  </style>
</head>

<body>
    <div class="wrapper">
    
        <header>
    
            <hgroup>
                <h1> 
                    <big> <big> MK Dynamics </big> </big>
                </h1>


                <h2>
                    Computer Security - Disassembling Binaries - Fortran - ARM 64-Bit Platform
                </h2>
            </hgroup>
    

            <nav>
                <ul>
                    <li> <a href="../../../../../index.php">Home</a> </li>
                    <li> <a href="../disassembling_binaries_Fortran.html">Back</a> </li>
                </ul>
            </nav>
    
        </header>
    
        <section class="content">
            
            <!-- ************************************************************************************** First Section Start ************ -->
            <section class="section">
        
                <div class="current_project_1">
                    
                    <hgroup>
                        <h2>
                            Introduction
                        </h2>
                    </hgroup>
                    
                    <!-- ********************************************************************* Loose Text -->                
                    <div class="loose_text">
                        
                        <p>
                            In this section we will be disassembling simple binaries generated by the Fortran high-level language compiled for the 64-bit ARM platform.  We will disassemble the binaries using GDB+GEF as well Radare2.
                        </p>
                        <p>
                            Project code for this section is contained in my <a href="https://github.com/markkhusid/Disassembling-Binaries/tree/master/Fortran/ARM_architecture/ARM64">github</a> repository.
                        </p>
                        
                    </div> <!-- .loose_text -->
                    <!-- ********************************************************************* Loose Text -->

                </div> <!-- .current_project_1 -->
        
            </section> <!-- first_section -->
            <!-- *********************************************************************************** Section End ************** -->
            
            <!-- *********************************************************************************** Section Start ************ -->
            <section class="section">
                
                <div class="current_project_2">
                
                    <hgroup>
                        <h2>
                            The program <i>add.f08</i>
                        </h2>
                    </hgroup>
                    
                    <!-- ********************************************************************* Loose Text -->                
                    <div class="loose_text">
                        
                        <p>
                            The screenshot below displays the contents of the program <i>add.f08</i>.  The program creates three integers: a, b, and c.  a is assigned the value of 1, b is assigned the value of 9, and c is assigned the result of the operation a + b.
                        </p>
                        
                        <figure>
                            <div class="img">
                                <img 
                                src="../../../images/Disassembling_binaries/Fortran/ARM64/add_f08.jpg"
                                width="1250"
                                height="900"
                                title=""
                                >
                            </div> <!-- .img -->
                        <div class="desc">
                            <p>
                                The program <i>add.f08</i>
                            <p>
                        </div> <!-- .desc -->
                    </figure>
                        
                        <p>
                            The program is obviously very simple, with no inputs and outputs.  The idea is to generate the binary and look at the disassembly to learn about the workings of the 64-bit ARM processor platform.
                        </p>
                        
                        <p>
                            The chosen test system is a instance on Amazon Web Services.  This is a new service that is powered by a 64-bit ARMv8 processor.  It fits very well for this application due to its availability and ease of access from multiple remote systems via SSH.
                        </p>
                        
                        <p>
                            The program is compiled with:
                            <blockquote>
                                $ gfortran -ggdb3 add.f08 -o add_int_Fortran_aarch64_ggdb3
                            </blockquote>
                        </p>
                        
                        <p>
                            For general edification, we also have gfortran produce generic assembly with the -S option, an object file with the -o option and object dumps of the object and executable files.
                        </p>
                        
                        <p>
                            The generic assembly is generated by using the -S (assembly) option:
                            <blockquote>
                                $ gfortran -S -ggdb3 add.f08 -o add.s
                            </blockquote>
                        </p>
                        
                        <p>
                            The object file is generated by using the -c (compile) option:
                            <blockquote>
                                $ gfortran -c -ggdb3 add.s -o add.o
                            </blockquote>
                        </p>
                        
                        <p>
                            The objdump files are generated by using the following command and options:
                            <blockquote>
                                $ objdump -x -D -S -s -g -t add.o > objdump_of_dot_o.txt<br>
                                $ objdump -x -D -S -s -g -t add_int_Fortran_aarch64_ggdb3 > objdump_of_dot_exe.txt
                            </blockquote>
                        </p>
                        
                        <p>
                            A rundown of the objdump options is shown here:
                            <blockquote>
<pre>
$objdump 
Usage: objdump (option(s)) (file(s))
Display information from object (file(s)).
 At least one of the following switches must be given:
  -a, --archive-headers    Display archive header information
  -f, --file-headers       Display the contents of the overall file header
  -p, --private-headers    Display object format specific file header contents
  -P, --private=OPT,OPT... Display object format specific contents
  -h, --[section-]headers  Display the contents of the section headers
  -x, --all-headers        Display the contents of all headers
  -d, --disassemble        Display assembler contents of executable sections
  -D, --disassemble-all    Display assembler contents of all sections
  -S, --source             Intermix source code with disassembly
  -s, --full-contents      Display the full contents of all sections requested
  -g, --debugging          Display debug information in object file
  -e, --debugging-tags     Display debug information using ctags style
  -G, --stabs              Display (in raw form) any STABS info in the file
  -W[lLiaprmfFsoRtUuTgAckK] or
  --dwarf[=rawline,=decodedline,=info,=abbrev,=pubnames,=aranges,=macro,=frames,
          =frames-interp,=str,=loc,=Ranges,=pubtypes,
          =gdb_index,=trace_info,=trace_abbrev,=trace_aranges,
          =addr,=cu_index,=links,=follow-links]
                           Display DWARF info in the file
  -t, --syms               Display the contents of the symbol table(s)
  -T, --dynamic-syms       Display the contents of the dynamic symbol table
  -r, --reloc              Display the relocation entries in the file
  -R, --dynamic-reloc      Display the dynamic relocation entries in the file
  @<file>                  Read options from <file>
  -v, --version            Display this program's version number
  -i, --info               List object formats and architectures supported
  -H, --help               Display this information
</pre>
                            </blockquote>
                        </p>
                        
                        <p>
                            In our case, we want -x (all headers), -D (disassemble all), -S (display source code with assembly), -s (full contents of all sections), -g (debug info), and finally, -t (display contents of the symbol tables).
                        </p>

                        <p>
                            We will now disassemble this program on the 64-bit ARM platform and step through the assembly instructions.
                        </p>

                    </div> <!-- .loose_text -->
                    <!-- ********************************************************************* Loose Text -->
                
                </div> <!-- .current_project_2 -->
            
            </section> <!-- section -->
            <!-- ************************************************************************************* Section End ************* -->
            
            
            <!-- *********************************************************************************** Section Start ************ -->
            <section class="section">
                
                <div class="current_project_3">
                
                    <hgroup>
                        <h2>
                            Disassembling <i>add_int_Fortran_aarch64_ggdb3</i> in GDB + GEF
                        </h2>
                    </hgroup>
                    
                    <!-- ********************************************************************* Loose Text -->                
                    <div class="loose_text">
                        
                        <p>
                            The debug process is started by entering:
                            <blockquote>
                                $gdb add_int_Fortran_aarch64_ggdb3
                            </blockquote>
                        </p>
                        
                        <p>
                            We then want to disassemble main.  Looking at main's disassembly, we notice a call at main+44 to a function at address 0x814 called <i>add</i>.  We then do a disassembly on this function as well.
                        </p>
                        
                    </div> <!-- .loose_text -->
                    <!-- ********************************************************************* Loose Text -->
                    
                    <figure>
                        <div class="img">
                            <img 
                            src="../../../images/Disassembling_binaries/Fortran/ARM64/running_add_Fortran_aarch64_in_GEF_showing_main.jpg"
                            width="1250"
                            height="900"
                            title=""
                            >
                        </div> <!-- .img -->
                        <div class="desc">
                            <p>
                                Disassembly of function <i>main</i>
                            <p>
                        </div> <!-- .desc -->
                    </figure>
                    
                    <!-- ********************************************************************* Loose Text -->                
                    <div class="loose_text">
                        
                        <p>
                            
                        </p>
                        
                    </div> <!-- .loose_text -->
                    <!-- ********************************************************************* Loose Text -->
                    
                    <figure>
                        <div class="img">
                            <img 
                            src="../../../images/Disassembling_binaries/Fortran/ARM64/running_add_Fortran_aarch64_in_GEF_showing_add.jpg"
                            width="1250"
                            height="900"
                            title=""
                            >
                        </div> <!-- .img -->
                        <div class="desc">
                            <p>
                                Disassembly of function <i>add</i>
                            <p>
                        </div> <!-- .desc -->
                    </figure>
                    
                    <!-- ********************************************************************* Loose Text -->                
                    <div class="loose_text">
                        
                        <p>
                            Referring to the function main, we notice that the function prologue consists of first a section that sets up internal Fortran arguments.  This occupies main+0 until main+24, where a branch occurs to the function _gfortran_set_args.  Subsequently, further configuration occurs from main+28 until main+40, where a branch to the function _gfortran_set_options occurs.  Finally, once that is complete, a branch to the function <i>add</i> occurs.  After that branch is finished, a clean up of the stack and a return value of 0 is setup in main+48 until main+56.  At main+56, a return to main's calling function is executed.
                        </p>
                        
                    </div> <!-- .loose_text -->
                    <!-- ********************************************************************* Loose Text -->
                
                </div> <!-- .current_project_2 -->
            
            </section> <!-- section -->
            <!-- ************************************************************************************* Section End ************* -->
        
            <!-- ************************************************************************************* Section Start *********** -->
            <section class="section">
                
                <div class="current_project_4">
                
                    <hgroup>
                        <h2>
                            Running <i>add_int_Fortran_aarch64_ggdb3</i> in GDB + GEF
                        </h2>
                    </hgroup>
                    
                    <!-- ********************************************************************* Loose Text -->                
                    <div class="loose_text">
                    
                        <p>
                            When we look at the executable's objdump, we notice that there are two functions of interest, one is main, and the other is MAIN__.  The Fortran compiler sets up the program arguments and options in main, while the actual program is contained within MAIN__ (that is capital MAIN followed by two underscores).
                        </p>
                        
                        <p>
                            The following text from the executable's objdump illustrates this:
                            <blockquote>
<pre>
00000000000007c4 (MAIN__):
program add
 7c4:	d10043ff 	sub	sp, sp, #0x10

    implicit none

    integer    :: a, b, c

    a = 1
 7c8:	52800020 	mov	w0, #0x1                   	// #1
 7cc:	b9000fe0 	str	w0, [sp, #12]
    b = 9
 7d0:	52800120 	mov	w0, #0x9                   	// #9
 7d4:	b9000be0 	str	w0, [sp, #8]

    c = a + b
 7d8:	b9400fe1 	ldr	w1, [sp, #12]
 7dc:	b9400be0 	ldr	w0, [sp, #8]
 7e0:	0b000020 	add	w0, w1, w0
 7e4:	b90007e0 	str	w0, [sp, #4]

end program add
 7e8:	d503201f 	nop
 7ec:	910043ff 	add	sp, sp, #0x10
 7f0:	d65f03c0 	ret

00000000000007f4 (main):
 7f4:	a9be7bfd 	stp	x29, x30, [sp, #-32]!
 7f8:	910003fd 	mov	x29, sp
 7fc:	b9001fa0 	str	w0, [x29, #28]
 800:	f9000ba1 	str	x1, [x29, #16]
 804:	f9400ba1 	ldr	x1, [x29, #16]
 808:	b9401fa0 	ldr	w0, [x29, #28]
 80c:	97ffff95 	bl	660 <_gfortran_set_args@plt>
 810:	90000000 	adrp	x0, 0 <_init-0x628>
 814:	91236000 	add	x0, x0, #0x8d8
 818:	aa0003e1 	mov	x1, x0
 81c:	528000e0 	mov	w0, #0x7                   	// #7
 820:	97ffffa4 	bl	6b0 <_gfortran_set_options@plt>
 824:	97ffffe8 	bl	7c4 <MAIN__>
 828:	52800000 	mov	w0, #0x0                   	// #0
 82c:	a8c27bfd 	ldp	x29, x30, [sp], #32
 830:	d65f03c0 	ret
 834:	00000000 	.inst	0x00000000 ; undefined

</pre>
                            </blockquote>
                        </p>
                        
                        <p>
                            We therefore want to set a breakpoint at *MAIN__.  We use the * to get at MAIN__ + 0.
                        </p>
                        
                        <p>
                            <blockquote>
<pre>
gef➤  break *MAIN__
Breakpoint 3 at 0xaaaaaaaaa7c4: file add.f08, line 1.
</pre>
                            </blockquote>
                        </p>
                        
                        <p>
                            The aarch64 has allot of registers (36 registers visible in GEF), and it becomes necessary to zoom out the screen to see the entire output of GEF.  For easier viewing on this website, we will display the output of GEF using two screenshots.
                        </p>
                        
                    </div> <!-- .loose_text -->
                    <!-- ********************************************************************* Loose Text -->

                    <figure>
                            <div class="img">
                                <img 
                                src="../../../images/Disassembling_binaries/Fortran/ARM64/running_add_Fortran_aarch64_in_GEF_showing_MAIN__1.jpg"
                                width="1250"
                                height="900"
                                title=""
                                >
                            </div> <!-- .img -->
                        <div class="desc">
                            <p>
                                MAIN__ in GDB+GEF Part 1
                            <p>
                        </div> <!-- .desc -->
                    </figure>
                    
                    <figure>
                            <div class="img">
                                <img 
                                src="../../../images/Disassembling_binaries/Fortran/ARM64/running_add_Fortran_aarch64_in_GEF_showing_MAIN__2.jpg"
                                width="1250"
                                height="900"
                                title=""
                                >
                            </div> <!-- .img -->
                        <div class="desc">
                            <p>
                                MAIN__ in GDB+GEF Part 2
                            <p>
                        </div> <!-- .desc -->
                    </figure>
                    
                     <!-- ********************************************************************* Loose Text -->                
                    <div class="loose_text">
                        <p>
                            Rather than taking screenshots of the state of GEF after exectuting every instruction, we will place comments on the assembly instructions in MAIN__ from the executable's objdump output.
                        </p>
                
                        <p>
                            <blockquote>
<pre>
00000000000007c4 (MAIN__):
program add
 7c4:	d10043ff 	sub	sp, sp, #0x10

    implicit none

    integer    :: a, b, c

    a = 1
 7c8:	52800020 	mov	w0, #0x1                // #1 - Moves a 1 into register w0
 7cc:	b9000fe0 	str	w0, [sp, #12]           //  - Stores the contents of register w0 into the stack pointer + 12.  
                                                        //  Recall that even though the machine is 64 bit, when defining a                              
                                                        //  variable as an integer, it is 32 bits in size.  In Fortran there are 
                                                        //  ways of changing the size of the integer as stored in memory.  
                                                        //  The compiler set aside 4x3 = 12 bytes to store these integers.  
                                                        //  The integer variable a is at sp + 12.

    b = 9
 7d0:	52800120 	mov	w0, #0x9                // #9 - Moves a 1 into register w0
 7d4:	b9000be0 	str	w0, [sp, #8]            //  - Stores the contents of register w0 into stack pointer + 8.  
                                                        // See above discussion for explanation.

    c = a + b                                           //  Now that the stack contains the addends, the machine can perform the operation.
 7d8:	b9400fe1 	ldr	w1, [sp, #12]           //  The variable a is loaded into register w1.
 7dc:	b9400be0 	ldr	w0, [sp, #8]            //  The variable b is loaded into register w0.
 7e0:	0b000020 	add	w0, w1, w0              //  w0 + w1 and store result into w0
 7e4:	b90007e0 	str	w0, [sp, #4]            //  Store the value in w0 into stack pointer + 4.  
                                                        //  Stack pointer + 4 is reserved for the integer variable c.

end program add
 7e8:	d503201f 	nop                             //  No Operation.  Usied for 64 bit boundary alignment.  
                                                        //  Interesting as to why that specific set of opcodes are used. Hmmmm....
 7ec:	910043ff 	add	sp, sp, #0x10           //  Clean up the stack.  Subtract 16 from the stack pointer.  
                                                        //  The additional 4 bytes beyond the three integer variables is for the base      
                                                        //  (frame) pointer.
 7f0:	d65f03c0 	ret                             //  Return to main by popping the return address off of 
                                                        //  the stack into the program counter (PC).

</pre>
                            </blockquote>
                            
                        </p>
                        
                        <p>
                            When stepping through the program, we can see the variables stored on the stack.  For example, in the text below, we can see at SP+4 we have 0xa (10 in decimal), which is the result of 1 + 9, or a + b.  Variable a is stored at SP + 12 and vriable b is stored at SP + 8.  I have bolded and spaced out the values on the stack for clarity.
                        </p>
                        
                        <p>
                            <blockquote>
<pre>
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x0000fffffffff250│+0x0000: 0x0000000 <b>a</b> 00000000	 ← $sp
0x0000fffffffff258│+0x0008: 0x0000000 <b>1</b> 0000000 <b>9</b>
0x0000fffffffff260│+0x0010: 0x0000fffffffff280  →  0x0000000000000000	 ← $x29
0x0000fffffffff268│+0x0018: 0x0000ffffbf4956e0  →  (__libc_start_main+224) bl 0xffffbf4a9f50 (__GI_exit)
0x0000fffffffff270│+0x0020: 0x0000fffffffff3b8  →  0x0000fffffffff5dd  →  "/home/ubuntu/Engineering/GITHUB/Disassembling-Bina[...]"
0x0000fffffffff278│+0x0028: 0x0000000100000000
0x0000fffffffff280│+0x0030: 0x0000000000000000
0x0000fffffffff288│+0x0038: 0x0000aaaaaaaaa6f4  →  (_start+52) bl 0xaaaaaaaaa6a0 (abort@plt)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:arm64:ARM ────
   0xaaaaaaaaa7d8 (MAIN__+20)      ldr    w1,  [sp,  #12]
   0xaaaaaaaaa7dc (MAIN__+24)      ldr    w0,  [sp,  #8]
   0xaaaaaaaaa7e0 (MAIN__+28)      add    w0,  w1,  w0
 → 0xaaaaaaaaa7e4 (MAIN__+32)      str    w0,  [sp,  #4]
   0xaaaaaaaaa7e8 (MAIN__+36)      nop    
   0xaaaaaaaaa7ec (MAIN__+40)      add    sp,  sp,  #0x10
   0xaaaaaaaaa7f0 (MAIN__+44)      ret    
   0xaaaaaaaaa7f4 (main+0)         stp    x29,  x30,  [sp,  #-32]!
   0xaaaaaaaaa7f8 (main+4)         mov    x29,  sp
   
</pre>
                            </blockquote>
                            
                        </p>

                    </div> <!-- .loose_text -->
                    <!-- ********************************************************************* Loose Text -->
                    
                </div> <!-- .current_project_4 -->

            </section> <!-- section -->
            <!-- ************************************************************************************* Section End ************ -->

        </section>	<!-- .content -->
    
    <div> <!-- .wrapper -->

  </body>

</html>
